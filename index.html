<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RidePro ‚Äî Customer (Live Vehicles)</title>

  <!-- Bootstrap + Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <link rel="icon" type="image/png" href="img/ridepro.png">

  <style>
  /* ------------- Brand colors & base ------------- */
  :root {
    --bg-900: #05060a;
    --bg-800: #071226;
    --panel: rgba(255,255,255,0.04);
    --glass: rgba(255,255,255,0.03);
    --muted: #9aa6b2;
    --accent: #c79a2f; /* gold */
    --accent-2: linear-gradient(90deg,#c79a2f,#f2cc6b);
    --card-shadow: 0 8px 30px rgba(0,0,0,0.65);
  }

  html, body {
    height: 100%;
    margin: 0;
    font-family: "Inter", system-ui, Arial, sans-serif;
    background: radial-gradient(1200px 400px at 10% 10%, rgba(199,154,47,0.06), transparent),
                linear-gradient(180deg, var(--bg-900), #071226 40%);
    color: #e7eef6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    overflow-y: auto;
    overflow-x: hidden;
  }

  /* ------------- Layout ------------- */
  .app {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    gap: 18px;
    padding: 18px;
    box-sizing: border-box;
  }

  header.app-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    flex-wrap: wrap;
  }

  .brand {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .brand .logo {
    width: 44px;
    height: 44px;
    border-radius: 10px;
    background: linear-gradient(135deg, #111 0%, rgba(255,255,255,0.02) 50%);
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid rgba(255,255,255,0.03);
    box-shadow: 0 6px 18px rgba(0,0,0,0.6);
    font-weight: 800;
    color: var(--accent);
    font-size: 18px;
  }

  .brand h1 {
    margin: 0;
    font-size: 18px;
    font-weight: 700;
    letter-spacing: 0.4px;
    color: #fff;
  }

  .brand p {
    margin: 0;
    font-size: 12px;
    color: var(--muted);
  }

  .top-actions {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }

  /* ------------- Main area: map + controls ------------- */
  .main {
    flex: 1;
    display: grid;
    grid-template-columns: 1fr 420px;
    gap: 18px;
  }

  #map {
    width: 100%;
    height: 100%;
    border-radius: 16px;
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.03);
    box-shadow: var(--card-shadow);
    background: linear-gradient(180deg, rgba(0,0,0,0.15), rgba(0,0,0,0.25));
  }

  /* Right panel */
  .right-panel {
    display: flex;
    flex-direction: column;
    gap: 16px;
    height: 100%;
    overflow-y: auto;
    padding-right: 4px;
  }

  .panel {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius: 14px;
    padding: 14px;
    box-shadow: 0 8px 24px rgba(2,6,23,0.6);
    border: 1px solid rgba(255,255,255,0.02);
  }

  /* Booking sheet (bottom) */
  .booking-sheet {
    position: fixed;
    left: 24px;
    bottom: 28px;
    width: min(720px, calc(100% - 48px));
    background: linear-gradient(180deg, rgba(7,18,36,0.9), rgba(7,18,36,0.85));
    border-radius: 14px;
    padding: 14px;
    box-shadow: 0 18px 60px rgba(0,0,0,0.6);
    border: 1px solid rgba(255,255,255,0.03);
    backdrop-filter: blur(6px);
    z-index: 30;
  }

  .booking-row {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
  }

  .booking-input { flex: 1; }

  .form-control, .form-select {
    background: rgba(255,255,255,0.02);
    border: 1px solid rgba(255,255,255,0.03);
    color: #fff;
  }

  .form-control::placeholder { color: rgba(255,255,255,0.32); }

  .small-muted { color: var(--muted); font-size: 13px; }

  .btn-primary-uber {
    background: linear-gradient(90deg, #0b0f13, #101419);
    border: 1px solid rgba(255,255,255,0.04);
    color: var(--accent);
    padding: 8px 14px;
    border-radius: 10px;
    font-weight: 700;
    box-shadow: 0 6px 18px rgba(0,0,0,0.6);
  }

  .btn-gold {
    background: var(--accent);
    color: #081019;
    border-radius: 10px;
    padding: 8px 12px;
    font-weight: 700;
    border: none;
  }

 /* Vehicles grid */
#vehiclesGrid {
  display: flex;
  flex-direction: column;
  gap: 12px;
  max-height: 70vh;
  overflow-y: auto;
  overflow-x: hidden;
  padding-right: 6px;
  scrollbar-width: thin;
  scrollbar-color: rgba(255,255,255,0.2) transparent;
}

/* Vehicle cards */
.vehicle-card {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 14px;
  padding: 12px;
  border-radius: 12px;
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.05);
  transition: transform 0.18s ease, box-shadow 0.18s ease, background 0.3s ease;
  box-shadow: 0 2px 12px rgba(0,0,0,0.3);
}

.vehicle-card:hover {
  transform: translateY(-3px);
  background: rgba(255,255,255,0.06);
  box-shadow: 0 8px 24px rgba(0,0,0,0.4);
}

/* Vehicle meta info */
.vehicle-meta {
  display: flex;
  align-items: center;
  gap: 14px;
  flex: 1;
}

/* Vehicle images */
.vehicle-img {
  width: 90px;
  height: 65px;
  border-radius: 10px;
  object-fit: cover;
  object-position: center;
  border: 1px solid rgba(255,255,255,0.1);
  box-shadow: 0 4px 10px rgba(0,0,0,0.4);
  background-color: rgba(255,255,255,0.08);
}

/* Driver text */
.driver-name {
  font-weight: 700;
  font-size: 15px;
  color: #fff;
}

.driver-type {
  font-size: 13px;
  color: var(--muted);
  margin-top: 2px;
}

/* Actions (status + buttons) */
.vehicle-actions {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 8px;
}

.status-badge {
  padding: 6px 10px;
  border-radius: 8px;
  font-weight: 700;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

/* Status colors */
.status-green {
  background: rgba(20, 70, 40, 0.9);
  color: #b6f6d2;
  border: 1px solid rgba(60,180,100,0.3);
}

.status-orange {
  background: rgba(80,50,0,0.8);
  color: #ffd9a8;
  border: 1px solid rgba(250,180,50,0.3);
}

.status-gray {
  background: rgba(50,60,70,0.8);
  color: #cdd6da;
  border: 1px solid rgba(150,150,150,0.2);
}

/* Small muted text */
.muted-small {
  color: var(--muted);
  font-size: 12px;
}

/* User chip */
.user-chip {
  display: flex;
  gap: 10px;
  align-items: center;
  padding: 8px 12px;
  border-radius: 999px;
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.05);
}

/* Responsive (mobile) */
@media (max-width: 768px) {
  #vehiclesGrid {
    gap: 10px;
    max-height: none;
    overflow: visible;
  }

  .vehicle-card {
    flex-direction: column;
    align-items: flex-start;
    width: 100%;
  }

  .vehicle-meta {
    flex-direction: column;
    width: 100%;
  }

  .vehicle-img {
    width: 100%;
    height: auto;
    max-height: 200px;
    border-radius: 12px;
  }

  .vehicle-actions {
    align-items: flex-start;
    width: 100%;
    margin-top: 8px;
  }
}


  .avatar {
    width: 36px;
    height: 36px;
    border-radius: 999px;
    background: linear-gradient(180deg,#0f1720,#0b1116);
    border: 1px solid rgba(255,255,255,0.04);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: var(--accent);
  }

  /* Modal */
  .modal-content {
    background: linear-gradient(180deg,#08121a,#07101a);
    color: #fff;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.03);
  }

  .modal .form-select,
  .modal .form-control {
    background: rgba(255,255,255,0.02);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.03);
  }

  /* Responsive */
  @media (max-width: 991px) {
    .main {
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .right-panel {
      position: relative;
      width: 100%;
      max-height: none;
      overflow: visible;
    }

    .booking-sheet {
      position: fixed;
      left: 12px;
      right: 12px;
      bottom: 20px;
      width: auto;
      z-index: 50;
    }

    #vehiclesGrid {
      max-height: none;
    }

    header.app-header {
      flex-direction: column;
      align-items: flex-start;
    }
  }

  @media (max-width: 600px) {
    .booking-row {
      flex-direction: column;
      align-items: stretch;
    }

    .vehicle-img {
      width: 56px;
      height: 40px;
    }

    .brand h1 {
      font-size: 16px;
    }

    .btn-primary-uber, .btn-gold {
      width: 100%;
      text-align: center;
    }
  }
  /* --- Mobile map fix --- */
#map {
  width: 100%;
  height: 100%;
  min-height: 60vh; /* ensures visible space on phones */
}

@media (max-width: 768px) {
  #map {
    height: calc(100vh - 200px); /* dynamic height for small screens */
  }
}
/* Fix overlapping Book button with modal */
.booking-fab {
  position: absolute;
  bottom: 20px;
  left: 20px;
  z-index: 1040; /* below modal */
}

/* Slight blur behind for polish */
.booking-fab button {
  box-shadow: 0 6px 18px rgba(0,0,0,0.5);
  backdrop-filter: blur(4px);
}

/* Hide or lower button when modal opens */
.modal-backdrop.show ~ .booking-fab {
  z-index: 0;
  opacity: 0.5;
  pointer-events: none;
}

</style>

</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="brand">
        <div class="logo">RP</div>
        <div>
          <h1>RidePro</h1>
          <p class="small-muted">Fast ‚Ä¢ Safe ‚Ä¢ Local</p>
        </div>
      </div>

      <!-- Dynamic Top Actions -->
<div class="top-actions d-flex align-items-center justify-content-between">
  <div id="userEmail" class="small-muted">Guest</div>
  <div class="d-flex align-items-center gap-2 user-chip">
    <div id="userAvatar" class="avatar">GU</div>
    <div id="userGreeting" class="small-muted">Good day</div>
  </div>
</div>

<script type="module">
  // --- DYNAMIC USER DETAILS & GREETING ---
  const userEmailEl = document.getElementById('userEmail');
  const userAvatarEl = document.getElementById('userAvatar');
  const userGreetingEl = document.getElementById('userGreeting');
  const custNameEl = document.getElementById('custName');

  // --- Persistent Browser ID ---
 
  if (!browserId) {
    browserId = 'BID-' + Math.random().toString(36).substring(2, 10).toUpperCase();
    localStorage.setItem('browserId', browserId);
  }

  // --- Local time-based greeting (auto detects user's timezone) ---
  function getGreeting() {
    const now = new Date();
    const hour = now.getHours();
    if (hour < 12) return "Good morning";
    if (hour < 18) return "Good afternoon";
    return "Good evening";
  }

  // --- Update UI dynamically ---
  function updateUserUI() {
    const name = custNameEl?.value?.trim();
    userEmailEl.textContent = name || "Guest";

    // Avatar initials
    userAvatarEl.textContent = name
      ? name.split(" ").map(w => w[0].toUpperCase()).join("").substring(0, 2)
      : "GU";

    // Update greeting with timezone awareness
    userGreetingEl.textContent = getGreeting();
  }

  // --- Initial load ---
  updateUserUI();

  // --- Watch for name changes ---
  if (custNameEl) {
    custNameEl.addEventListener("input", () => {
      localStorage.setItem("custName", custNameEl.value);
      updateUserUI();
    });
  }

  // --- Persist name from localStorage ---
  const savedName = localStorage.getItem("custName");
  if (savedName && custNameEl) {
    custNameEl.value = savedName;
    updateUserUI();
  }

  // --- Auto refresh greeting every 5 minutes ---
  setInterval(() => {
    userGreetingEl.textContent = getGreeting();
  }, 5 * 60 * 1000);
</script>

<style>
  .top-actions {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    margin-bottom: 10px;
    gap: 10px;
  }

  .user-chip {
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.05);
    border-radius: 999px;
    padding: 6px 12px;
  }

  .avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--accent, #c79a2f);
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    flex-shrink: 0;
  }

  .small-muted {
    color: var(--muted);
    font-size: 13px;
  }
</style>

    </header>

   <div class="main">
  <!-- Left: Map -->
  <div style="position:relative;">
    <div id="map"></div>

    <!-- BOOK A RIDE BUTTON -->
    <div class="booking-fab">
  <button class="shadow rounded-pill btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#bookingModal">
    üöó Book a Ride
  </button>
</div>

  </div>

  <!-- Right: panels -->
  <div class="right-panel">
    <div class="panel">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div><strong>Available Vehicles</strong></div>
        <div class="small-muted">Nearby drivers</div>
      </div>
      <div id="vehiclesGrid"></div>
    </div>

    <div class="panel">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div><strong>Recent Requests</strong></div>
        <div class="small-muted">Your rides</div>
      </div>
      <div id="requestsList" class="list-group" style="max-height:180px;overflow:auto;"></div>
    </div>

    <div class="panel">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <strong>Loyalty</strong>
          <div class="small-muted">Earn points after ride completion</div>
        </div>
        <div>
          <button class="btn-outline-light btn btn-sm">View</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- BOOKING MODAL -->
<div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
    <div class="bg-dark shadow-lg border border-secondary rounded-4 text-light modal-content">
      <div class="border-secondary modal-header">
        <h5 class="modal-title fw-bold" id="bookingModalLabel">üöñ Quick Ride Booking</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="booking-sheet" role="region" aria-label="Book a ride">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <div>
              <div class="small-muted">Where to?</div>
              <div style="font-weight:700;font-size:18px;">Quick ride</div>
            </div>
            <div>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              <select id="vehicleType" class="form-select-sm form-select"
                style="background:transparent;color:#24aa3d;border:none;min-width:150px;">
                <option value="car" selected>Car ‚Äî Standard (1-2)</option>
                <option value="premium">Van ‚Äî Premium (6-8)</option>
                <option value="bike">Motorbike</option>
                <option value="van">Car (4)</option>
              </select>
            </div>
          </div>

          <!-- CUSTOMER DETAILS -->
          <div class="mt-3 row g-2">
            <div class="col-md-4">
              <label class="form-label small-muted">Customer name (optional)</label>
              <input id="custName" class="form-control form-control-sm" placeholder="Full name" />
            </div>
            <div class="col-md-4">
              <label class="form-label small-muted">Phone for M-Pesa (07XX...)</label>
              <input id="custPhone" class="form-control form-control-sm" placeholder="e.g., 07XXXXXXXX" />
            </div>
            <div class="col-md-4">
              <label class="form-label small-muted">Promo / Loyalty code</label>
              <input id="promo" class="form-control form-control-sm" placeholder="Optional" />
            </div>
          </div>

          <hr class="text-muted" />

          <div class="mb-2 booking-row">
            <div class="booking-input">
              <label class="mb-1 small-muted">Pickup</label>
              <input id="pickup" class="form-control form-control-sm" placeholder="Enter pickup location" />
            </div>
            <div style="width:14px"></div>
            <div class="booking-input">
              <label class="mb-1 small-muted">Destination</label>
              <input id="destination" class="form-control form-control-sm" placeholder="Enter destination" />
            </div>
            <div style="width:10px"></div>
            <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px;">
              <button id="btnUseLocation" title="Use my location" class="btn-outline-light btn btn-sm"><svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" fill="#c79a2f" viewBox="0 0 384 512">
  <path d="M168 0C75 0 0 75 0 168c0 87.2 160 344 160 344s160-256.8 160-344C320 75 245 0 168 0zm0 224c-30.9 0-56-25.1-56-56s25.1-56 56-56 56 25.1 56 56-25.1 56-56 56z"/>
</svg>
</button>
            </div>
          </div>

          <div class="d-flex align-items-center justify-content-between mb-3">
            <div class="small-muted">
              <div>Distance <div id="estDistance" class="fw-bold">‚Äî</div></div>
            </div>
            <div class="small-muted">
              <div>Time <div id="estDuration" class="fw-bold">‚Äî</div></div>
            </div>
            <div class="text-end">
              <div class="small-muted">Fare</div>
              <div id="estFare" style="font-weight:800;color:var(--accent);font-size:20px;">KSh 0</div>
            </div>
          </div>

          <div class="d-flex justify-content-end gap-2">
            <button id="btnEstimate" class="btn-outline-light btn btn-sm">Estimate</button>
            <button id="btnRequestWhatsapp" class="btn-outline-success btn btn-sm">WhatsApp</button>
            <button id="btnProceedPayment" class="btn btn-gold btn-sm">Request Ride</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

  <!-- Rate Driver Modal (kept same IDs) -->
  <div class="modal fade" id="rateModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="border-secondary modal-header">
        <h5 class="text-light modal-title">Rate Driver</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="text-light modal-body">
        <p id="rateModalDriverName" class="fw-semibold"></p>
        <select id="rateModalSelect" class="bg-dark border-secondary text-light form-select">
          <option value="1">1 ‚≠ê</option>
          <option value="2">2 ‚≠ê</option>
          <option value="3">3 ‚≠ê</option>
          <option value="4">4 ‚≠ê</option>
          <option value="5">5 ‚≠ê</option>
        </select>
      </div>
      <div class="border-secondary modal-footer">
        <button type="button" class="btn btn-gold" id="rateModalSubmit">Submit</button>
        <button type="button" class="btn-outline-light btn" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

  <!-- Receipt Modal (kept same IDs) -->
  <div class="modal fade" id="receiptModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="p-3 modal-content">
        <div id="receiptBody"></div>
        <div class="mt-2 text-end">
          <button id="printReceipt" class="btn-outline-secondary btn btn-sm">Print</button>
          <button id="downloadReceipt" class="btn-outline-primary btn btn-sm">Download PDF</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dependencies (keep these as before) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Google Maps (unchanged) -->
  <script async defer 
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAAOQyp4Y7DmN2SFGR6RVFHcn6gzY-vTdw&map_ids=be09314611473507241a937c&libraries=places&callback=initMap">
  </script>

  <!-- Your existing scripts (unchanged) -->
  <script type="module">
    // ---------------- Firebase imports ----------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, getDocs, query, where, orderBy, increment, limit
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    import { getStorage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // ---------------- CONFIG (unchanged) ----------------
    const firebaseConfig = {
      apiKey: "AIzaSyC0avd1EPsYGw9paeuECB8dd781ZPQBAMI",
      authDomain: "transc-eec4c.firebaseapp.com",
      projectId: "transc-eec4c",
      storageBucket: "transc-eec4c.firebasestorage.app",
      messagingSenderId: "3676403115",
      appId: "1:3676403115:web:4da31c41de4b990b614eee",
      measurementId: "G-R29NT412SJ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ---------------- UI refs (kept exact IDs) ----------------
    const pickupInput = document.getElementById('pickup');
    const destInput = document.getElementById('destination');
    const btnEstimate = document.getElementById('btnEstimate');
    const btnProceedPayment = document.getElementById('btnProceedPayment');
    const estDistance = document.getElementById('estDistance');
    const estDuration = document.getElementById('estDuration');
    const estFare = document.getElementById('estFare');
    const vehicleType = document.getElementById('vehicleType');
    const requestsList = document.getElementById('requestsList');
    const custName = document.getElementById('custName') || { value: '' }; // optional field on UI may be absent in this layout
    const custPhone = document.getElementById('custPhone') || { value: '' };
    const vehiclesGrid = document.getElementById('vehiclesGrid');
    const btnUseLocation = document.getElementById('btnUseLocation');
    const btnRequestWhatsapp = document.getElementById('btnRequestWhatsapp');

    // ---------------- Browser ID ----------------
    const browserId = localStorage.getItem('browserId') || crypto.randomUUID();
    localStorage.setItem('browserId', browserId);

    // ---------------- FARE RATES + calcFare (kept same) ----------------
    const FARE_RATES = {
      car: { base: 115, perKm: 22, perMin: 6 },
      premium: { base: 200, perKm: 55, perMin: 8 },
      bike: { base: 8, perKm: 4, perMin: 4 },
      van: { base: 200, perKm: 35, perMin: 7 },
    };
    function calcFare(km, mins, type) {
      const rate = FARE_RATES[type] || FARE_RATES.car;
      return Math.round(rate.base + km * rate.perKm + mins * rate.perMin);
    }

    // ---------------- Google Maps variables ----------------
    let map, directionsService, directionsRenderer;
    let pickupAutocomplete, destAutocomplete;
    let pickupPlace = null, destPlace = null;
    let userMarker = null;
    let vehicleMarkers = {};

    // Minimal initMap placeholder if maps callback isn't ready yet
    function initMap() {
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: -1.286389, lng: 36.817223 },
        zoom: 13,
        mapId: "be09314611473507241a937c",
        mapTypeControl: false
      });

      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map, suppressMarkers: true });

      pickupAutocomplete = new google.maps.places.Autocomplete(pickupInput);
      destAutocomplete = new google.maps.places.Autocomplete(destInput);

      pickupAutocomplete.addListener('place_changed', () => {
        pickupPlace = pickupAutocomplete.getPlace();
        if (pickupPlace?.geometry?.location) map.panTo(pickupPlace.geometry.location);
      });
      destAutocomplete.addListener('place_changed', () => {
        destPlace = destAutocomplete.getPlace();
        if (destPlace?.geometry?.location) map.panTo(destPlace.geometry.location);
      });

      btnUseLocation.onclick = () => {
        if (!navigator.geolocation) return alert('Geolocation not supported.');
        navigator.geolocation.getCurrentPosition(pos => {
          const loc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          map.panTo(loc);
          map.setZoom(15);
          if (!userMarker) {
            userMarker = new google.maps.Marker({ position: loc, map, title: 'You are here' });
          } else userMarker.setPosition(loc);
          const geocoder = new google.maps.Geocoder();
          geocoder.geocode({ location: loc }, (results, status) => {
            if (status === 'OK' && results?.[0]) {
              pickupInput.value = results[0].formatted_address;
              pickupPlace = { geometry: { location: new google.maps.LatLng(loc.lat, loc.lng) }, formatted_address: results[0].formatted_address };
            }
          });
        }, err => alert('Location error: ' + err.message));
      };

      btnEstimate.onclick = estimateRoute;
    }

    function estimateRoute() {
      const a = pickupInput.value.trim();
      const b = destInput.value.trim();
      if (!a || !b) return alert('Enter both pickup and destination.');

      estDistance.textContent = 'Calculating...';
      estDuration.textContent = 'Calculating...';
      estFare.textContent = 'Calculating...';

      const req = { origin: a, destination: b, travelMode: google.maps.TravelMode.DRIVING };
      directionsService.route(req, (result, status) => {
        if (status !== 'OK') return alert('Route failed: ' + status);
        directionsRenderer.setDirections(result);
        const leg = result.routes[0].legs[0];
        const km = (leg.distance.value || 0) / 1000;
        const mins = Math.ceil((leg.duration.value || 0) / 60);
        const type = vehicleType.value || 'car';
        const fare = calcFare(km, mins, type);
        estDistance.textContent = `${km.toFixed(1)} km`;
        estDuration.textContent = `${mins} min`;
        estFare.textContent = `KSh ${fare.toLocaleString()}`;
        window._estimate = { pickupText: a, destText: b, km, mins, fare, type };
      });
    }

   // ---------------- VEHICLES (Realtime) ----------------
onSnapshot(collection(db, 'vehicles'), snap => {
  const list = [];
  snap.forEach(d => list.push({ id: d.id, ...d.data() }));
  renderVehiclesGrid(list);
  plotVehicleMarkers(list);
});

async function renderVehiclesGrid(list) {
  vehiclesGrid.innerHTML = '';

  for (const v of list.filter(v => ['available', 'busy', 'offline'].includes(v.status || 'available'))) {
    const col = document.createElement('div');
    col.className = 'mb-2';

    const img = v.image
      ? `<img src="${escapeHtml(v.image)}" class="me-2 vehicle-img">`
      : '';

    const statusTag =
      v.status === 'available'
        ? '<span class="status-green">Available</span>'
        : v.status === 'busy'
        ? '<span class="status-orange">Busy</span>'
        : '<span class="status-gray">Offline</span>';

    const callBtn = v.phone
      ? `<a href="tel:${v.phone}" class="ms-2 btn btn-success btn-sm">
           <i class="bi bi-telephone"></i> Call
         </a>`
      : '';

    const avgRating = v.ratingCount ? (v.rating / v.ratingCount).toFixed(1) : 'No ratings';
    const stars = v.ratingCount ? '‚≠ê'.repeat(Math.round(v.rating / v.ratingCount)) : '‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ';

    // --- Check if current user has a completed ride with this vehicle ---
    const q = query(
      collection(db, 'rides'),
      where('vehicleId', '==', v.id),
      where('browserId', '==', browserId),
      where('status', '==', 'completed')
    );
    const ridesSnapshot = await getDocs(q);
    const showRateBtn = !ridesSnapshot.empty;

    const rateBtn = showRateBtn
      ? `<button class="mt-1 btn btn-warning btn-sm" onclick="rateDriver('${v.id}', '${escapeHtml(v.name || v.type)}')">
           ‚≠ê Rate Driver
         </button>`
      : '';

    col.innerHTML = `
      <div class="d-flex align-items-center justify-content-between p-2"
           style="background:rgba(255,255,255,0.02);border-radius:8px">
        <div class="d-flex align-items-center">
          ${img}
          <div>
            <div class="fw-bold">${escapeHtml(v.name || v.type || 'Vehicle')}</div>
            <div class="small-muted">${escapeHtml(v.type || '')}</div>
            <div class="text-warning small vehicle-stars" data-driver-id="${v.id}">${stars} (${avgRating})</div>
          </div>
        </div>
        <div class="text-end">
          ${statusTag}
          <div class="mt-1 muted small">
            ${typeof v.latitude === 'number' && typeof v.longitude === 'number' ? 'Live' : 'No GPS'}
          </div>
          ${callBtn}
          ${rateBtn}
        </div>
      </div>
    `;
    vehiclesGrid.appendChild(col);
  }
}

// ---------------- Rate Driver using Bootstrap Modal ----------------
window.rateDriver = function(driverId, driverName) {
  document.getElementById('rateModalDriverName').textContent = `Rate ${driverName}`;
  const submitBtn = document.getElementById('rateModalSubmit');

  submitBtn.replaceWith(submitBtn.cloneNode(true)); // remove old handlers
  const newSubmitBtn = document.getElementById('rateModalSubmit');

  newSubmitBtn.onclick = async () => {
    const r = parseInt(document.getElementById('rateModalSelect').value);
    if (isNaN(r) || r < 1 || r > 5) return alert('Invalid rating');

    const driverRef = doc(db, 'vehicles', driverId);

    try {
      // --- Update Firestore directly ---
      await updateDoc(driverRef, {
        rating: increment(r),
        ratingCount: increment(1)
      });

      alert(`Thanks for rating ${driverName}! ‚≠ê`);

      // Optional: close modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('rateModal'));
      modal.hide();
    } catch (err) {
      console.error('Failed to submit rating:', err);
      alert('Failed to submit rating: ' + err.message);
    }
  };

  const modal = new bootstrap.Modal(document.getElementById('rateModal'));
  modal.show();
};

    // ---------------- PLOT VEHICLE MARKERS ----------------
    function plotVehicleMarkers(list) {
      // This function originally used Leaflet ‚Äî here we keep a minimal marker sync for Maps API
      // If you use Leaflet replace logic; for now we do light marker update using google.maps markers
      const present = new Set(list.map(l => l.id));
      for (const id of Object.keys(vehicleMarkers)) {
        if (!present.has(id)) {
          vehicleMarkers[id].setMap(null);
          delete vehicleMarkers[id];
        }
      }
      list.forEach(v => {
        if (typeof v.latitude !== 'number' || typeof v.longitude !== 'number') return;
        const pos = { lat: v.latitude, lng: v.longitude };
        if (vehicleMarkers[v.id]) vehicleMarkers[v.id].setPosition(pos);
        else {
          vehicleMarkers[v.id] = new google.maps.Marker({
            position: pos,
            map,
            title: v.name || v.type || 'Driver'
          });
        }
      });
    }

    // ---------------- REQUEST RIDE (kept same) ----------------
    // NOTE: custName/custPhone fields moved in original layout; keep fallback if missing
    const custNameInput = document.getElementById('custName');
    const custPhoneInput = document.getElementById('custPhone');

    async function selectDriver() {
      const drivers = await getAvailableDrivers();
      if (drivers.length === 0) {
        alert('No available drivers at the moment.');
        return null;
      }

      const sel = document.createElement('select');
      sel.className = 'form-select mb-2';
      sel.innerHTML =
        `<option value="">Select a driver (optional)</option>` +
        drivers.map(d => `<option value="${d.id}">${escapeHtml(d.name)}</option>`).join('');

      const container = document.createElement('div');
      container.appendChild(sel);

      const res = await new Promise(resolve => {
        const okBtn = document.createElement('button');
        okBtn.className = 'btn btn-primary btn-sm';
        okBtn.textContent = 'Confirm';
        container.appendChild(okBtn);

        const modalDiv = document.createElement('div');
        modalDiv.className = 'modal fade';
        modalDiv.tabIndex = -1;
        modalDiv.innerHTML = `<div class="modal-dialog modal-dialog-centered"><div class="p-3 modal-content"></div></div>`;
        modalDiv.querySelector('.modal-content').appendChild(container);
        document.body.appendChild(modalDiv);
        const modal = new bootstrap.Modal(modalDiv);
        modal.show();

        okBtn.onclick = () => {
          const selectedId = sel.value;
          const selectedName = drivers.find(d => d.id === selectedId)?.name || null;
          resolve({ id: selectedId, name: selectedName });
          modal.hide();
          modalDiv.remove();
        };
      });

      return res; // {id, name} or null
    }

    async function getAvailableDrivers() {
      const snap = await getDocs(query(collection(db, 'vehicles'), where('status', '==', 'available')));
      return snap.docs.map(d => ({
        id: d.id,
        name: d.data().name || d.data().driverName || d.data().type || 'Driver'
      }));
    }

    // Request handlers (kept same)
    document.getElementById('btnProceedPayment')?.addEventListener('click', async () => {
      if (!window._estimate) return alert('Get estimate first.');
      const phone = (custPhoneInput && custPhoneInput.value.trim()) || '';
      const name = (custNameInput && custNameInput.value.trim()) || 'Guest';
      if (!/^07\d{8}$/.test(phone)) return alert('Enter valid Kenyan phone.');

      const selectedDriver = await selectDriver();
      if (!selectedDriver) {
        if (!confirm('No driver selected. Continue anyway?')) return;
      }

      const ride = {
        pickup: window._estimate.pickupText,
        destination: window._estimate.destText,
        estimate: window._estimate,
        requestedAt: new Date().toISOString(),
        status: 'requested',
        customerName: name,
        customerPhone: phone,
        browserId,
        driverId: selectedDriver?.id || null,
        driverName: selectedDriver?.name || null
      };

      await addDoc(collection(db, 'rides'), ride);
      alert('Ride requested successfully!');
    });

    document.getElementById('btnRequestWhatsapp')?.addEventListener('click', async () => {
      if (!window._estimate) return alert('Get estimate first.');
      const phone = (custPhoneInput && custPhoneInput.value.trim()) || '';
      const name = (custNameInput && custNameInput.value.trim()) || 'Guest';
      if (!/^07\d{8}$/.test(phone)) return alert('Enter valid Kenyan phone.');

      const selectedDriver = await selectDriver();
      if (!selectedDriver) {
        if (!confirm('No driver selected. Continue anyway?')) return;
      }

      const pickup = window._estimate.pickupText || 'N/A';
      const destination = window._estimate.destText || 'N/A';

      const rawFare = window._estimate.fare || window._estimate.amount || window._estimate.fareText || '';
      const fareVal = (() => {
        if (!rawFare) return null;
        const m = String(rawFare).match(/[\d.,]+/);
        if (!m) return null;
        return parseFloat(m[0].replace(',', '.'));
      })();

      const fmtCurrency = (v) => {
        if (v == null || Number.isNaN(v)) return (typeof rawFare === 'string' && rawFare) || 'N/A';
        try {
          return new Intl.NumberFormat('en-KE', { style: 'currency', currency: 'KES' }).format(v);
        } catch (e) {
          return `KSh ${v}`;
        }
      };

      const distanceDisplay = window._estimate.km ? `${window._estimate.km.toFixed(2)} km` : 'N/A';
      const fareDisplay = fmtCurrency(fareVal);
      const driverName = selectedDriver?.name || 'Not assigned';

      const adminNumber = '254790427109';
      const message = encodeURIComponent(
        `üöñ *New Ride Request via RidePro*\n\n` +
        `üë§ Name: ${name}\nüìû Phone: ${phone}\n` +
        `üìç Pickup: ${pickup}\nüèÅ Destination: ${destination}\n` +
        `üìè Distance: ${distanceDisplay}\nüí∞ Estimated Fare: ${fareDisplay}\nüöó Driver: ${driverName}\n\n` +
        `üïí Requested At: ${new Date().toLocaleString()}`
      );

      window.open(`https://wa.me/${adminNumber}?text=${message}`, '_blank');

      const ride = {
        pickup: window._estimate.pickupText,
        destination: window._estimate.destText,
        estimate: window._estimate,
        requestedAt: new Date().toISOString(),
        status: 'requested',
        customerName: name,
        customerPhone: phone,
        browserId,
        driverId: selectedDriver?.id || null,
        driverName: selectedDriver?.name || null
      };
      await addDoc(collection(db, 'rides'), ride);
      alert('Ride requested successfully and sent via WhatsApp!');
    });

    // User's own rides (kept same)
    onSnapshot(collection(db, 'rides'), snap => {
      const myRides = [];
      snap.forEach(docSnap => {
        const r = { id: docSnap.id, ...docSnap.data() };
        if (r.browserId === browserId) myRides.push(r);
      });
      myRides.sort((a, b) => new Date(b.requestedAt) - new Date(a.requestedAt));
      renderRequests(myRides);
    });

    function renderRequests(list) {
      requestsList.innerHTML = '';
      list.forEach(r => {
        const el = document.createElement('div');
        el.className = 'list-group-item bg-transparent text-light border rounded mb-2 p-2';
        el.innerHTML = `
          <div><b>${escapeHtml(r.pickup)}</b> ‚Üí <b>${escapeHtml(r.destination)}</b></div>
          <div class="small">Fare: KSh ${Number(r.estimate?.fare || 0).toLocaleString()}</div>
          <div class="badge ${badgeForStatus(r.status)}">${escapeHtml(r.status)}</div>
        `;
        requestsList.appendChild(el);
      });
    }

    function badgeForStatus(status) {
      return status === 'requested' ? 'bg-warning text-dark' :
             status === 'accepted' ? 'bg-info' :
             status === 'ongoing' ? 'bg-primary' :
             status === 'completed' ? 'bg-success' : 'bg-secondary';
    }

    function escapeHtml(s) {
      return String(s || '').replace(/[&<>"']/g, m => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    }

    // initialize maps if ready
    if (typeof google !== 'undefined' && google.maps) initMap();
    else {
      const check = setInterval(() => {
        if (typeof google !== 'undefined' && google.maps) {
          clearInterval(check);
          initMap();
        }
      }, 300);
    }

  </script>
</body>
</html>
